{% extends "layout/admin.html" %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="page-header d-print-none p-0 mb-3" aria-label="Page header">
                <div>
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h1 style="font-size: 30px;"><span x-text="title">{{ service.name }}</span></h1>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <span class="d-none d-sm-inline">
                                    <a class="btn btn-md" onclick="startService('{{ service.unit }}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8l-13 -8" /></svg>
                                        Start
                                    </a>
                                    <a class="btn btn-md" onclick="stopService('{{ service.unit }}')">
                                        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-stop"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 5m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z" /></svg>
                                        Stop
                                    </a>
                                    <a class="btn btn-md btn-primary" onclick="restartService('{{ service.unit }}')">
                                        <svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-repeat"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3" /><path d="M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3" /></svg>
                                        Restart
                                    </a>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <pre id="logBox" style="width:100%; height:750px !important; overflow:auto; background:#000; color: white; padding:10px;"></pre>
        </div>
    </div>
</div>

<script>
    function startService(unit) {
        fetch(`/api/systemd/${unit}/start`, { method: 'POST' })
            .then(r => r.text())
            .then(console.log);
    }

    function stopService(unit) {
        fetch(`/api/systemd/${unit}/stop`, { method: 'POST' })
            .then(r => r.text())
            .then(console.log);
    }

    function restartService(unit) {
        stopService(unit);
        setTimeout(() => startService(unit), 500);
    }

    function showLogs(unit) {
        const logBox = document.getElementById('logBox');
        fetch(`/api/systemd/${unit}/logs`)
            .then(r => r.text())
            .then(text => logBox.textContent = text);
    }

    let logInterval;
    function liveLogs(unit) {
        if(logInterval) clearInterval(logInterval);
        const logBox = document.getElementById('logBox');

        logInterval = setInterval(() => {
            fetch(`/api/systemd/${unit}/logs`)
                .then(r => r.text())
                .then(text => {
                    logBox.innerHTML = colorizeLog(text);
                    logBox.scrollTop = logBox.scrollHeight;
                });
        }, 2000);
    }

    function colorizeLog(text) {
        // Retirer la ligne "Status:"
        const lines = text.split('\n').filter(line => !line.startsWith('Status:'));

        return lines.map(line => {
            // Échapper les caractères HTML pour éviter les problèmes
            let parts = [];

            // Parser la ligne en parties distinctes
            // Format: "Jan 10 08:53:36 vps-492e9cd2 java[24658]: message"
            const dateMatch = line.match(/^([A-Z][a-z]{2}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})\s+/);

            if (dateMatch) {
                const date = dateMatch[1];
                const rest = line.substring(dateMatch[0].length);

                // Coloriser la date
                parts.push(`<span style="color:#00d4ff">${date}</span>`);

                // Parser le reste: hostname processname[pid]: message
                const hostMatch = rest.match(/^(\S+)\s+/);
                if (hostMatch) {
                    const hostname = hostMatch[1];
                    const afterHost = rest.substring(hostMatch[0].length);

                    // Coloriser hostname
                    parts.push(` <span style="color:#9b59b6">${hostname}</span>`);

                    // Parser process[pid]:
                    const procMatch = afterHost.match(/^(\w+)\[(\d+)\]:\s*/);
                    if (procMatch) {
                        const procName = procMatch[1];
                        const pid = procMatch[2];
                        const message = afterHost.substring(procMatch[0].length);

                        // Coloriser process et PID
                        if (procName === 'systemd') {
                            parts.push(` <span style="color:#e91e63">${procName}</span>[<span style="color:#e67e22">${pid}</span>]: `);
                        } else {
                            parts.push(` <span style="color:#f39c12">${procName}</span>[<span style="color:#e67e22">${pid}</span>]: `);
                        }

                        // Coloriser le message
                        parts.push(colorizeMessage(message));
                    } else {
                        parts.push(` ${afterHost}`);
                    }
                } else {
                    parts.push(` ${rest}`);
                }

                return parts.join('');
            } else {
                // Ligne sans date (continuation)
                return colorizeMessage(line);
            }
        }).join('\n');
    }

    function colorizeMessage(msg) {
        let result = msg;

        // Mots-clés importants
        result = result.replace(/\b(Starting|Started)\b/g, '<span style="color:#2ecc71"><strong>$1</strong></span>');
        result = result.replace(/\b(Stopping|Stopped)\b/g, '<span style="color:#e74c3c"><strong>$1</strong></span>');
        result = result.replace(/\b(Failed|ERROR|Error)\b/gi, '<span style="color:#ff0000"><strong>$1</strong></span>');
        result = result.replace(/\b(WARNING|WARN)\b/gi, '<span style="color:#ff9800"><strong>$1</strong></span>');

        // INFO
        result = result.replace(/\bINFO\b/g, '<span style="color:#03a9f4">INFO</span>');

        // SQLite, Database, Loading, Chargement
        result = result.replace(/\b(SQLite|Database|Loading|Chargement)\b/g, '<span style="color:#ba68c8">$1</span>');

        // URLs
        result = result.replace(/(https?:\/\/[^\s]+)/g, '<span style="color:#00bcd4"><u>$1</u></span>');

        // Thread names (qtp..., main)
        result = result.replace(/\b(qtp[\d\-]+|main)\b/g, '<span style="color:#ffeb3b">$1</span>');

        // Status
        result = result.replace(/\b(active|running|enabled)\b/gi, '<span style="color:#4caf50">$1</span>');
        result = result.replace(/\b(inactive|dead|disabled)\b/gi, '<span style="color:#f44336">$1</span>');

        return result;
    }

    document.addEventListener("DOMContentLoaded", () => liveLogs('{{ service.unit }}'));
</script>
{% endblock %}
